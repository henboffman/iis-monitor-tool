@page "/sites/{SiteName}"
@inject IISMonitorService IISMonitor
@inject NavigationManager Navigation
@rendermode InteractiveServer

<PageTitle>IIS Monitor - @(_site?.Name ?? "Site")</PageTitle>

@if (_site == null)
{
    <div class="alert alert-warning">
        <i class="bi bi-exclamation-triangle me-2"></i>
        Site not found. <a href="sites">Return to Sites</a>
    </div>
}
else
{
    <nav aria-label="breadcrumb" class="mb-3">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="">Overview</a></li>
            <li class="breadcrumb-item"><a href="sites">Sites</a></li>
            <li class="breadcrumb-item active">@_site.Name</li>
        </ol>
    </nav>

    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1 class="mb-0">@_site.Name</h1>
            <small class="text-muted">
                App Pool: <a href="apppools/@Uri.EscapeDataString(_site.AppPoolName)">@_site.AppPoolName</a>
            </small>
        </div>
        <div>
            <span class="badge fs-5 @(_site.State == "Started" ? "bg-success" : "bg-danger") me-2">
                @_site.State
            </span>
            @if (_site.LastChecked.HasValue)
            {
                <span class="badge fs-5 @(_site.IsResponding ? "bg-success" : "bg-danger")">
                    @(_site.IsResponding ? "Responding" : "Not Responding")
                </span>
            }
        </div>
    </div>

    <!-- Summary Cards -->
    <div class="row mb-4">
        <div class="col-md-3 mb-3">
            <div class="card h-100 text-center">
                <div class="card-body">
                    <h3 class="@(_healthSummary.UptimePercentage >= 99 ? "text-success" : _healthSummary.UptimePercentage >= 95 ? "text-warning" : "text-danger")">
                        @_healthSummary.UptimePercentage.ToString("F1")%
                    </h3>
                    <small class="text-muted">Uptime (24h)</small>
                </div>
            </div>
        </div>
        <div class="col-md-3 mb-3">
            <div class="card h-100 text-center">
                <div class="card-body">
                    <h3>@_healthSummary.AverageResponseTimeMs.ToString("F0")<small class="fs-6">ms</small></h3>
                    <small class="text-muted">Avg Response</small>
                </div>
            </div>
        </div>
        <div class="col-md-3 mb-3">
            <div class="card h-100 text-center">
                <div class="card-body">
                    <h3 class="text-primary">@_site.Applications.Count</h3>
                    <small class="text-muted">Applications</small>
                </div>
            </div>
        </div>
        <div class="col-md-3 mb-3">
            <div class="card h-100 text-center">
                <div class="card-body">
                    <h3 class="@(_healthSummary.FailedChecks > 0 ? "text-danger" : "text-success")">@_healthSummary.FailedChecks</h3>
                    <small class="text-muted">Failed Checks</small>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Site Details -->
        <div class="col-lg-6 mb-4">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0"><i class="bi bi-info-circle me-2"></i>Site Details</h5>
                </div>
                <div class="card-body">
                    <table class="table table-sm mb-0">
                        <tbody>
                            <tr>
                                <td class="fw-bold">Site ID</td>
                                <td>@_site.Id</td>
                            </tr>
                            <tr>
                                <td class="fw-bold">State</td>
                                <td>
                                    <span class="badge @(_site.State == "Started" ? "bg-success" : "bg-danger")">
                                        @_site.State
                                    </span>
                                </td>
                            </tr>
                            <tr>
                                <td class="fw-bold">Physical Path</td>
                                <td><code class="small">@_site.PhysicalPath</code></td>
                            </tr>
                            <tr>
                                <td class="fw-bold">Bindings</td>
                                <td>
                                    @foreach (var binding in _site.Bindings)
                                    {
                                        <div><code>@binding.Protocol://@(string.IsNullOrEmpty(binding.Host) ? "*" : binding.Host)@GetPortDisplay(binding)</code></div>
                                    }
                                </td>
                            </tr>
                            <tr>
                                <td class="fw-bold">Last Checked</td>
                                <td>@(_site.LastChecked.HasValue ? FormatTime(_site.LastChecked.Value) : "--")</td>
                            </tr>
                            <tr>
                                <td class="fw-bold">Response Time</td>
                                <td>@(_site.ResponseTimeMs > 0 ? $"{_site.ResponseTimeMs}ms" : "--")</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Applications in this Site -->
        <div class="col-lg-6 mb-4">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0"><i class="bi bi-app-indicator me-2"></i>Applications (@_site.Applications.Count)</h5>
                </div>
                <div class="card-body p-0">
                    @if (_site.Applications.Count > 0)
                    {
                        <div class="list-group list-group-flush">
                            @foreach (var app in _site.Applications)
                            {
                                <a href="@($"applications/{Uri.EscapeDataString(_site.Name)}{app.Path}")" class="list-group-item list-group-item-action @(!app.IsResponding && app.LastChecked.HasValue ? "list-group-item-danger" : "")">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <div>
                                            <strong>@app.Path</strong>
                                            <br />
                                            <small class="text-muted">@app.AppPoolName</small>
                                        </div>
                                        <div class="text-end">
                                            @if (app.LastChecked.HasValue)
                                            {
                                                <span class="badge @(app.IsResponding ? "bg-success" : "bg-danger")">
                                                    @(app.HttpStatusCode?.ToString() ?? (app.IsResponding ? "OK" : "Error"))
                                                </span>
                                                <br />
                                                <small>@(app.ResponseTimeMs > 0 ? $"{app.ResponseTimeMs}ms" : "")</small>
                                            }
                                            else
                                            {
                                                <span class="badge bg-secondary">Pending</span>
                                            }
                                        </div>
                                    </div>
                                </a>
                            }
                        </div>
                    }
                    else
                    {
                        <div class="text-center py-4 text-muted">
                            <p>No applications under this site</p>
                        </div>
                    }
                </div>
            </div>
        </div>
    </div>

    <!-- Status History -->
    <div class="card mb-4">
        <div class="card-header">
            <h5 class="mb-0"><i class="bi bi-graph-up me-2"></i>Site Status History</h5>
        </div>
        <div class="card-body">
            @if (_history.Count > 0)
            {
                <!-- Simple visual timeline -->
                <div class="mb-3">
                    <div class="d-flex flex-wrap" style="gap: 2px;">
                        @foreach (var entry in _history.Take(50))
                        {
                            <div class="@(entry.IsResponding ? "bg-success" : "bg-danger")"
                                 style="width: 20px; height: 30px; border-radius: 3px;"
                                 title="@FormatTimeShort(entry.Timestamp) - @(entry.IsResponding ? $"OK ({entry.ResponseTimeMs}ms)" : entry.ErrorMessage ?? "Error")">
                            </div>
                        }
                    </div>
                    <small class="text-muted">Last @Math.Min(50, _history.Count) checks (newest first)</small>
                </div>

                <div class="table-responsive" style="max-height: 300px; overflow-y: auto;">
                    <table class="table table-sm table-hover mb-0">
                        <thead class="table-light sticky-top">
                            <tr>
                                <th>Time</th>
                                <th>Status</th>
                                <th>Response</th>
                                <th>Details</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var entry in _history)
                            {
                                <tr class="@(!entry.IsResponding ? "table-danger" : "")">
                                    <td><small>@FormatTimeShort(entry.Timestamp)</small></td>
                                    <td>
                                        <span class="badge @(entry.IsResponding ? "bg-success" : "bg-danger")">
                                            @(entry.HttpStatusCode?.ToString() ?? (entry.IsResponding ? "OK" : "Error"))
                                        </span>
                                    </td>
                                    <td>@(entry.ResponseTimeMs > 0 ? $"{entry.ResponseTimeMs}ms" : "--")</td>
                                    <td>
                                        @if (!string.IsNullOrEmpty(entry.ErrorMessage))
                                        {
                                            <small class="text-danger" title="@entry.ErrorMessage">
                                                @(entry.ErrorMessage.Length > 50 ? entry.ErrorMessage[..50] + "..." : entry.ErrorMessage)
                                            </small>
                                        }
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            }
            else
            {
                <div class="text-center py-4 text-muted">
                    <p>No history recorded yet.</p>
                </div>
            }
        </div>
    </div>

    <div class="mt-3">
        <button class="btn btn-primary" @onclick="RefreshData" disabled="@_isLoading">
            <i class="bi bi-arrow-clockwise me-1"></i>Refresh
        </button>
        <a href="sites" class="btn btn-outline-secondary ms-2">
            <i class="bi bi-arrow-left me-1"></i>Back to Sites
        </a>
    </div>
}

@code {
    [Parameter] public string SiteName { get; set; } = string.Empty;

    private SiteInfo? _site;
    private List<StatusHistoryEntry> _history = new();
    private HealthSummary _healthSummary = new();
    private bool _isLoading;
    private static readonly TimeZoneInfo _easternZone = TimeZoneInfo.FindSystemTimeZoneById("Eastern Standard Time");

    protected override void OnInitialized()
    {
        RefreshData();
    }

    protected override void OnParametersSet()
    {
        RefreshData();
    }

    private void RefreshData()
    {
        _isLoading = true;

        var decodedSiteName = Uri.UnescapeDataString(SiteName);
        _site = IISMonitor.GetSiteByName(decodedSiteName);

        if (_site != null)
        {
            _history = IISMonitor.GetSiteHistory(decodedSiteName);
            _healthSummary = IISMonitor.GetSiteHealthSummary(decodedSiteName);
        }

        _isLoading = false;
    }

    private string GetPortDisplay(BindingInfo binding)
    {
        var parts = binding.BindingInformation.Split(':');
        if (parts.Length >= 2)
        {
            var port = parts[1];
            if ((binding.Protocol == "http" && port == "80") ||
                (binding.Protocol == "https" && port == "443"))
                return "";
            return $":{port}";
        }
        return "";
    }

    private string FormatTime(DateTime utcTime)
    {
        var eastern = TimeZoneInfo.ConvertTimeFromUtc(utcTime, _easternZone);
        var offset = _easternZone.IsDaylightSavingTime(eastern) ? "EDT" : "EST";
        return $"{eastern:yyyy-MM-dd HH:mm:ss} {offset}";
    }

    private string FormatTimeShort(DateTime utcTime)
    {
        var eastern = TimeZoneInfo.ConvertTimeFromUtc(utcTime, _easternZone);
        var offset = _easternZone.IsDaylightSavingTime(eastern) ? "EDT" : "EST";
        return $"{eastern:MM/dd HH:mm:ss} {offset}";
    }
}
